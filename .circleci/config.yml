# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build_and_test:
    docker:
      - image: cimg/node:16.14.2 # TODO: use our own custom frontend image
    steps:
      - checkout
      - run: mkdir -p $TEST_RESULTS
      - run: yarn
      - run: yarn test
      - store_artifacts: # upload test summary for display in Artifacts
          path: /tmp/test-results
          destination: raw-test-output

      - store_test_results: # upload test results for display in Test Summary
          path: /tmp/test-results
    environment:
      TEST_RESULTS: /tmp/test-results 
  
  publish:
    docker:
      - image: cimg/node:16.14.2
    steps:
      - checkout
      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
      - run:
          name: Publish package
          command: npm publish

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_test_deploy:
    jobs:
      - build_and_test:
          context:
            - aws
      - deploy:
          requires:
            - build_and_test
          filters:
            branches:
              only: master
          context:
            - aws
            - npm
